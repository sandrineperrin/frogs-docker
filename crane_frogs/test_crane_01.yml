containers:
  init:
    image: biom_to_tsv:2.1.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["ls", "-l"]
  
  affotu:
    image: affiliation_otu:0.9.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["affiliation_OTU.py","--reference","$frogs_dir/test/data/db.fasta","--input-fasta","$out_dir/04-filters.fasta","--input-biom","$out_dir/04-filters.biom","--output-biom","$out_dir/04-affiliation.biom","--summary","$out_dir/04-affiliation.html","--log-file","$out_dir/04-affiliation.log","--nb-cpus","$nb_cpu","--java-mem","$java_mem"]
 
  affstat:
    image: affiliations_stat:1.1.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["affiliations_stat.py","--input-biom","$out_dir/04-affiliation.biom","--output-file","$out_dir/06-affiliationsStat.html","--log-file","$out_dir/06-affiliationsStat.log","--tax-consensus-tag","blast_taxonomy","--identity-tag","perc_identity","--coverage-tag","perc_query_coverage","--multiple-tag","blast_affiliations","--rarefaction-ranks","Family","Genus","Species"]

  biomtsv: 
   image: biom_to_tsv:2.1.0
   run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["biom_to_tsv.py","--input-biom","$out_dir/04-affiliation.biom","--input-fasta","$out_dir/04-filters.fasta","--output-tsv","$out_dir/07-biom2tsv.tsv","--output-multi-affi","$out_dir/07-biom2tsv.multi","--log-file","$out_dir/07-biom2tsv.log"]

  biomstd:
    image: biom_to_stdbiom:1.1.1 
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["biom_to_stdBiom.py", "-b", "../example.biom"]

  cluster:
    image: clusters_stat:1.1.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["clusters_stat.py","--input-biom","$out_dir/04-affiliation.biom","--output-file","$out_dir/05-clustersStat.html","--log-file","$out_dir/05-clustersStat.log"]

  demux: 
    image: demultiplex:1.1.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["demultiplex.py", "--input-R1","../test.fastq","--input-barcode","../index.tsv"]

  filter:
    image: filters:1.2.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["filters.py","--min-abundance","0.00005","--input-biom","$out_dir/03-chimera.biom","--input-fasta","$out_dir/03-chimera.fasta","--output-fasta","$out_dir/04-filters.fasta","--output-biom","$out_dir/04-filters.biom","--excluded","$out_dir/04-filters.excluded","--summary","$out_dir/04-filters.html","--log-file","$out_dir/04-filters.log"]

  norm:
    image: normalisation:0.6.0
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["normalisation.py","-h"]


  prep:
    image: preprocess:latest
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["preprocess.py","illumina","--min-amplicon-size","380","--max-amplicon-size","460","--five-prim-primer","GGCGVACGGGTGAGTAA","--three-prim-primer","GTGCCAGCNGCNGCGG","--R1-size","250","--R2-size","250","--expected-amplicon-size","420","--input-archive","$frogs_dir/test/data/test_dataset.tar.gz","--output-dereplicated","$out_dir/01-prepro.fasta","--output-count","$out_dir/01-prepro.tsv","--summary","$out_dir/01-prepro.html","--log-file","$out_dir/01-prepro.log"]

  clust:
    image: clustering:latest
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["clustering.py","--distance","3","--denoising","--input-fasta","$out_dir/01-prepro.fasta","--input-count","$out_dir/01-prepro.tsv","--output-biom","$out_dir/02-clustering.biom","--output-fasta","$out_dir/02-clustering.fasta","--output-compo","$out_dir/02-clustering_compo.tsv","--log-file","$out_dir/02-clustering.log","--nb-cpus","$nb_cpu"]

  remov:
    image: remove_chimera:latest
    run:
      volume: ["/root/data:/root"]
      workdir: "/root/out"
      cmd: ["remove_chimera.py","--input-fasta","$out_dir/02-clustering.fasta","--input-biom","$out_dir/02-clustering.biom","--non-chimera","$out_dir/03-chimera.fasta","--out-abundance","$out_dir/03-chimera.biom","--summary","$out_dir/03-chimera.html","--log-file","$out_dir/03-chimera.log","--nb-cpus","$nb_cpu"]
    

groups:
  wkf:
    - prep
    - clust
    - remov
    - filter
    - affotu
    - cluster
    - affstat
    - biomtsv

  add:
    - biomstd
    - demux
hooks:
  foo:
    post-start: echo container from foo started
  bar:
    post-stop: echo container from bar stopped
